/**
 ******************************************************************************
 * @file    flash_font.h
 * @author  菜菜why(B站:菜菜whyy)
 * @brief   Flash字库驱动头文件 - GB2312完整字库存储方案（内存映射模式）
 ******************************************************************************
 * @attention
 *
 * 使用前提：
 * ---------------------------------------------------------------
 * 1. 字库已通过STM32CubeProgrammer预烧录到QSPI Flash
 * 2. QSPI已配置为内存映射模式（由外部QSPI驱动负责）
 * 3. 字库数据可通过 W25Qxx_Mem_Addr (0x90000000) 直接访问
 *
 * 字库烧录地址分配:
 * ┌──────────────────┬──────────────┬──────────────────┐
 * │ 文件名           │ 烧录地址      │ 说明             │
 * ├──────────────────┼──────────────┼──────────────────┤
 * │ font_12x12_*.bin │ 0x91D00000   │ 12x12字库        │
 * │ font_16x16_*.bin │ 0x91D2BBE0   │ 16x16字库        │
 * │ font_20x20_*.bin │ 0x91D66100   │ 20x20字库        │
 * │ font_24x24_*.bin │ 0x91DD3680   │ 24x24字库        │
 * │ font_32x32_*.bin │ 0x91E569E0   │ 32x32字库        │
 * │ gb2312_table.bin │ 0x91F3FE00   │ GB2312对照表     │
 * │ flag.bin         │ 0x91F472D0   │ 标志位           │
 * └──────────────────┴──────────────┴──────────────────┘
 *
 * 模块解耦说明:
 * - 本模块不依赖 qspi_flash 模块的任何API
 * - 仅依赖内存映射基地址 W25Qxx_Mem_Addr
 * - QSPI的初始化和内存映射配置由外部完成
 */

#ifndef FLASH_FONT_H
#define FLASH_FONT_H

#ifdef __cplusplus
extern "C"
{
#endif

#include "init.h"
#include <stdint.h>

/*******************************************************************************
 *                          内存映射基地址定义
 ******************************************************************************/
#define W25Qxx_Mem_Addr 0x90000000 /*!< QSPI内存映射模式基地址 */

/*******************************************************************************
 *                          Flash字体存储地址分配
 *******************************************************************************/
/**
 * @brief QSPI Flash字库存储区域定义(相对于Flash起始地址的偏移)
 */
#define FONT_12x12_ADDR 0x1D00000 /*!< 12x12字体区域起始地址  */
#define FONT_16x16_ADDR 0x1D2BBE0 /*!< 16x16字体区域起始地址  */
#define FONT_20x20_ADDR 0x1D66100 /*!< 20x20字体区域起始地址  */
#define FONT_24x24_ADDR 0x1DD3680 /*!< 24x24字体区域起始地址 */
#define FONT_32x32_ADDR 0x1E569E0 /*!< 32x32字体区域起始地址 */

#define GB2312_TABLE_ADDR 0x1F3FE00 /*!< GB2312对照表地址 */
#define FONT_FLAG_ADDR 0x1F472D0    /*!< 字库标志存储地址 */

    /*******************************************************************************
     *                          字库标志结构定义
     ******************************************************************************/
    /**
     * @brief  字库写入标志结构体
     * @note   存储在Flash固定地址FONT_FLAG_ADDR,用于标记字库是否已写入
     */
    typedef struct
    {
        uint32_t magic;      /*!< 魔数 0x464C4147 ("FLAG") 用于验证数据有效性 */
        uint8_t font_12_ok;  /*!< 12x12字库写入完成标志: 0=未写入, 1=已写入 */
        uint8_t font_16_ok;  /*!< 16x16字库写入完成标志: 0=未写入, 1=已写入 */
        uint8_t font_20_ok;  /*!< 20x20字库写入完成标志: 0=未写入, 1=已写入 */
        uint8_t font_24_ok;  /*!< 24x24字库写入完成标志: 0=未写入, 1=已写入 */
        uint8_t font_32_ok;  /*!< 32x32字库写入完成标志: 0=未写入, 1=已写入 */
        uint8_t reserved[3]; /*!< 保留字节(4字节对齐) */
    } FontWriteFlag_t;

    /*******************************************************************************
     *                          GB2312对照表结构定义
     ******************************************************************************/
    /**
     * @brief  GB2312对照表头信息结构体
     * @note   存储在Flash中，用于快速查找汉字对应的字库索引
     */
    typedef struct
    {
        uint32_t magic;       /*!< 魔数 0x54424C47 ("TBLG") 用于验证数据有效性 */
        uint32_t char_count;  /*!< 字符总数 (7464个) */
        uint32_t data_offset; /*!< 数据区起始偏移(相对表头=12) */
    } GB2312_TableHeader_t;

    /**
     * @brief  GB2312对照表数据项(每条4字节)
     * @note   格式: uint16_t gbk_code + uint16_t index
     */
    typedef struct
    {
        uint16_t gbk_code; /*!< GBK编码(2字节) */
        uint16_t index;    /*!< 字库索引(2字节) */
    } GB2312_TableEntry_t;

    /*******************************************************************************
     *                          字体索引头结构定义
     ******************************************************************************/
    /**
     * @brief  GB2312字库头信息结构体
     * @note   每个字库区域开头18字节存储该结构,用于快速定位字模数据
     */
    typedef struct
    {
        uint32_t magic;          /*!< 魔数 0x47423332 ("GB23") 用于验证数据有效性 */
        uint16_t font_width;     /*!< 字体宽度(像素) */
        uint16_t font_height;    /*!< 字体高度(像素) */
        uint32_t char_count;     /*!< 字符总数(GB2312标准为7445个) */
        uint32_t data_addr;      /*!< 字模数据起始地址(Flash绝对地址) */
        uint16_t bytes_per_char; /*!< 每字符字节数 */
    } FontHeader_GB2312_t;

    /*******************************************************************************
     *                          导出函数声明
     ******************************************************************************/

    /**
     * @brief  初始化Flash字库驱动
     * @note   前提：QSPI已开启内存映射模式，字库已预烧录
     * @retval 0-成功, <0-失败
     */
    int8_t FlashFont_Init(void);

    /**
     * @brief  验证指定字库是否已烧录
     * @param  font_size: 字体大小(12/16/20/24/32)
     * @retval 1-已烧录, 0-未烧录
     */
    int8_t FlashFont_IsValid(uint8_t font_size);

    /**
     * @brief  从Flash查找汉字对应的字库索引
     * @param  text: 汉字字符串(GBK编码，2字节)
     * @retval 字库索引(0-7463), 未找到返回-1
     * @note   使用线性查找，适合少量查询
     */
    int16_t GB2312_FindIndex_Flash(const char *text);

#ifdef __cplusplus
}
#endif

#endif // FLASH_FONT_H
